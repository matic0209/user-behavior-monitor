# 工作流程测试指南

## 📋 概述

本指南介绍如何使用测试工具来验证用户行为监控系统的完整工作流程，从数据生成到特征处理、模型训练，再到在线预测。

## 🛠️ 测试工具

### 1. 完整工作流程测试 (`test_complete_workflow.py`)

**用途**：完整的端到端测试，模拟真实使用场景

**特点**：
- 生成多个测试用户的数据
- 每个用户有不同的鼠标行为模式
- 完整的特征处理和模型训练流程
- 详细的测试报告

**适用场景**：
- 系统集成测试
- 性能验证
- 功能完整性检查

### 2. 快速工作流程测试 (`quick_workflow_test.py`)

**用途**：快速验证各个组件是否正常工作

**特点**：
- 生成少量测试数据
- 快速验证核心功能
- 简化的测试流程
- 快速反馈结果

**适用场景**：
- 开发调试
- 快速功能验证
- 问题排查

## 🚀 使用方法

### 快速测试（推荐先运行）

```bash
# 运行快速测试
python quick_workflow_test.py
```

**预期输出**：
```
🔧 快速工作流程测试工具
========================================
开始快速工作流程测试
========================================

📊 步骤1: 生成测试数据
生成快速测试数据...
生成了 200 条测试数据

🗄️ 步骤2: 测试数据库操作
测试数据库操作...
✅ 数据库操作测试成功
  鼠标事件数: 200
  特征数据数: 50

🔧 步骤3: 测试特征处理
测试特征处理...
✅ 特征处理测试成功

🤖 步骤4: 测试模型训练
测试模型训练...
✅ 模型训练测试成功

🎯 步骤5: 测试预测功能
测试预测功能...
✅ 预测功能测试成功
  异常分数: 0.123

快速测试结果报告
==================================================
  data_generation: ✅ 通过
  database: ✅ 通过
  feature_processing: ✅ 通过
  model_training: ✅ 通过
  prediction: ✅ 通过

总体成功率: 100.0% (5/5)
🎉 所有测试都通过了！工作流程运行正常。
```

### 完整测试

```bash
# 运行完整测试
python test_complete_workflow.py
```

**预期输出**：
```
🔧 完整工作流程测试工具
============================================================
开始完整工作流程测试
============================================================

📊 步骤1: 生成测试数据
开始生成测试鼠标数据...
为用户 test_user_1 生成数据...
为用户 test_user_2 生成数据...
为用户 test_user_3 生成数据...
测试鼠标数据生成完成

🔧 步骤2: 处理特征
开始特征处理...
处理用户 test_user_1 的特征...
会话 test_user_1_session_1 特征处理成功
...
特征处理完成

🤖 步骤3: 训练模型
开始模型训练...
训练用户 test_user_1 的模型...
用户 test_user_1 模型训练成功
...
模型训练完成

🎯 步骤4: 测试在线预测
开始在线预测测试...
测试用户 test_user_1 的在线预测...
用户 test_user_1 预测结果:
  异常分数: 0.156
  预测结果: normal
  置信度: 0.892
...
在线预测测试完成

============================================================
✅ 完整工作流程测试成功完成！
============================================================

📋 生成测试报告...
测试报告已保存到: logs/test_report.json

📊 测试报告摘要:
  测试时间: 2024-01-15T10:30:45.123456
  测试用户数: 3
  鼠标事件总数: 4500
  特征数据总数: 150
  训练模型数: 3
  模型文件: user_test_user_1_model.pkl, user_test_user_2_model.pkl, user_test_user_3_model.pkl
```

## 📊 测试数据说明

### 用户行为模式

测试工具会生成三种不同的用户行为模式：

1. **test_user_1**：慢速、高精度、线性移动
   - 鼠标移动缓慢且精确
   - 主要进行线性轨迹移动
   - 适合测试精确度要求高的场景

2. **test_user_2**：快速、中等精度、随机移动
   - 鼠标移动快速且随机
   - 更多点击事件
   - 适合测试动态行为检测

3. **test_user_3**：中速、低精度、圆形移动
   - 鼠标移动呈圆形轨迹
   - 精度相对较低
   - 适合测试模式识别

### 数据量配置

#### 快速测试
- 用户数：1个
- 事件数：200个
- 预计耗时：1-2分钟

#### 完整测试
- 用户数：3个
- 每用户会话数：3个
- 每会话事件数：500个
- 总事件数：4500个
- 预计耗时：5-10分钟

## 📈 测试报告

### 快速测试报告 (`logs/quick_test_report.json`)

```json
{
  "test_time": "2024-01-15T10:30:45.123456",
  "test_user": "quick_test_user",
  "events_count": 200,
  "results": {
    "data_generation": true,
    "database": true,
    "feature_processing": true,
    "model_training": true,
    "prediction": true
  },
  "success_rate": 100.0
}
```

### 完整测试报告 (`logs/test_report.json`)

```json
{
  "test_time": "2024-01-15T10:30:45.123456",
  "test_users": ["test_user_1", "test_user_2", "test_user_3"],
  "sessions_per_user": 3,
  "events_per_session": 500,
  "total_events": 4500,
  "mouse_events_count": 4500,
  "features_count": 150,
  "trained_models": [
    "user_test_user_1_model.pkl",
    "user_test_user_2_model.pkl",
    "user_test_user_3_model.pkl"
  ],
  "model_count": 3
}
```

## 🔍 故障排除

### 常见问题

1. **导入错误**
   ```
   ModuleNotFoundError: No module named 'src.core'
   ```
   **解决方案**：确保在项目根目录下运行测试

2. **数据库错误**
   ```
   sqlite3.OperationalError: no such table
   ```
   **解决方案**：测试工具会自动创建必要的表结构

3. **特征处理失败**
   ```
   ❌ 特征处理测试失败
   ```
   **解决方案**：检查数据量是否足够（至少100个事件）

4. **模型训练失败**
   ```
   ❌ 模型训练测试失败
   ```
   **解决方案**：确保有足够的特征数据和负样本

### 调试建议

1. **查看详细日志**
   ```bash
   tail -f logs/monitor_*.log
   ```

2. **检查数据库内容**
   ```bash
   sqlite3 data/mouse_data.db "SELECT COUNT(*) FROM mouse_events;"
   sqlite3 data/mouse_data.db "SELECT COUNT(*) FROM features;"
   ```

3. **验证模型文件**
   ```bash
   ls -la models/user_*_model.pkl
   ```

## 🎯 测试验证

### 成功标准

1. **快速测试**：所有5个测试项目都通过
2. **完整测试**：所有用户都能成功训练模型
3. **预测功能**：能够返回合理的异常分数

### 性能指标

- **数据生成速度**：>1000事件/秒
- **特征处理速度**：>100事件/秒
- **模型训练时间**：<2分钟/用户
- **预测响应时间**：<1秒

## 📝 注意事项

1. **测试环境**：确保在干净的环境中运行测试
2. **数据清理**：测试会清理现有的测试数据
3. **资源需求**：完整测试需要较多内存和CPU资源
4. **时间安排**：建议在非高峰期运行完整测试

## 🔄 持续集成

可以将测试工具集成到CI/CD流程中：

```yaml
# .github/workflows/test.yml
- name: Run Workflow Tests
  run: |
    python quick_workflow_test.py
    python test_complete_workflow.py
```

这样可以确保每次代码更新后，整个工作流程都能正常运行。
