# 用户行为监控系统使用指南

## 快速开始

### 1. 系统启动

```bash
python start_monitor.py
```

启动后，系统会显示快捷键说明和当前用户信息。

### 2. 快捷键控制流程

系统采用快捷键手动控制各个阶段，提供最大的灵活性：

#### 第一阶段：数据采集
```
Ctrl+Alt+C → 开始数据采集
    ↓
[系统开始收集鼠标行为数据]
    ↓
Ctrl+Alt+S → 停止数据采集
```

#### 第二阶段：特征处理和模型训练
```
Ctrl+Alt+F → 处理特征
    ↓
[从采集数据中提取行为特征]
    ↓
Ctrl+Alt+T → 训练模型
    ↓
[使用特征训练异常检测模型]
```

#### 第三阶段：在线预测和监控
```
Ctrl+Alt+P → 开始预测
    ↓
[开始在线异常检测]
    ↓
[自动检测异常并发送告警]
    ↓
Ctrl+Alt+X → 停止预测
```

#### 其他功能
```
Ctrl+Alt+I → 显示系统状态
Ctrl+Alt+R → 重新训练（生成新用户ID）
Ctrl+Alt+Q → 退出系统
```

## 详细使用说明

### 用户ID生成机制

系统会自动从Windows登录用户生成用户ID：

- **正常用户**: `{Windows用户名}_{时间戳}`
  - 例如: `john_1703123456`
  
- **重新训练用户**: `{Windows用户名}_retrain_{时间戳}`
  - 例如: `john_retrain_1703123457`

### 数据采集阶段

1. **开始采集**: 按 `Ctrl+Alt+C`
   - 系统开始收集鼠标移动、点击、滚动事件
   - 建议采集10-30分钟的正常行为数据
   - 采集过程中可以正常使用电脑

2. **停止采集**: 按 `Ctrl+Alt+S`
   - 停止数据采集
   - 数据会自动保存到数据库

### 特征处理阶段

按 `Ctrl+Alt+F` 处理特征：
- 从采集的原始数据中提取行为特征
- 包括速度、轨迹、时间、统计等多种特征
- 处理结果保存到特征数据库

### 模型训练阶段

按 `Ctrl+Alt+T` 训练模型：
- 使用提取的特征训练异常检测模型
- 采用隔离森林算法进行异常检测
- 模型文件保存到 `models/` 目录

### 在线预测阶段

1. **开始预测**: 按 `Ctrl+Alt+P`
   - 开始实时异常检测
   - 系统会分析当前鼠标行为
   - 检测到异常时自动发送告警

2. **停止预测**: 按 `Ctrl+Alt+X`
   - 停止在线异常检测
   - 可以随时重新开始

### 重新训练

按 `Ctrl+Alt+R` 重新训练：
- 系统会生成新的用户ID
- 重新处理所有会话的特征
- 重新训练模型
- 适用于用户行为模式发生变化的情况

### 状态监控

按 `Ctrl+Alt+I` 显示系统状态：
```
=== 系统状态 ===
运行状态: 运行中
当前用户: john_1703123456
数据采集: 已停止
在线预测: 运行中
会话ID: session_1703123456
异常统计 (24小时): 5/1000 (0.50%)
================
```

## 配置说明

### 系统配置

编辑 `src/utils/config/config.yaml` 文件：

```yaml
# 数据采集配置
data_collection:
  sample_rate: 0.1  # 采样率（0.1表示每10个事件记录1个）
  session_duration: 3600  # 会话时长（秒）

# 特征处理配置
feature_engineering:
  window_size: 100  # 滑动窗口大小
  feature_types: ["statistical", "temporal", "spatial"]

# 模型训练配置
model_training:
  algorithm: "isolation_forest"  # 异常检测算法
  contamination: 0.1  # 异常比例
  random_state: 42

# 预测配置
prediction:
  threshold: 0.8  # 异常检测阈值
  batch_size: 50  # 批处理大小

# 告警配置
alerting:
  enabled: true
  channels: ["console", "file"]  # 告警渠道
  severity_levels: ["info", "warning", "error"]
```

### 快捷键配置

可以在 `src/core/user_manager.py` 中修改快捷键：

```python
self.hotkeys = {
    'start_collection': {keyboard.Key.ctrl, keyboard.Key.alt, keyboard.KeyCode.from_char('C')},
    'stop_collection': {keyboard.Key.ctrl, keyboard.Key.alt, keyboard.KeyCode.from_char('S')},
    # ... 其他快捷键
}
```

## 数据管理

### 数据导入

如果有历史数据，可以先导入：

```bash
python import_training_data.py
```

### 数据目录结构

```
data/
├── raw/                    # 原始数据
│   ├── user_1/
│   └── user_2/
├── processed/              # 处理后的数据
│   ├── features/
│   └── sessions/
└── user_behavior.db        # SQLite数据库
```

### 模型文件

```
models/
├── user_1_model.pkl        # 用户1的模型
├── user_2_model.pkl        # 用户2的模型
└── feature_info.json       # 特征信息
```

## 日志和监控

### 日志文件

- **主日志**: `logs/monitor.log`
- **告警日志**: `logs/alerts/`
- **错误日志**: `logs/errors/`

### 日志级别

- `INFO`: 一般信息
- `WARNING`: 警告信息
- `ERROR`: 错误信息
- `DEBUG`: 调试信息

### 实时监控

按 `Ctrl+Alt+I` 查看实时状态，包括：
- 系统运行状态
- 当前用户信息
- 数据采集状态
- 预测状态
- 异常统计

## 故障排除

### 常见问题

1. **快捷键无响应**
   - 确保以管理员权限运行程序
   - 检查是否有其他程序占用快捷键
   - 重启程序

2. **数据采集失败**
   - 检查鼠标权限设置
   - 确认Windows版本兼容性
   - 查看日志文件获取详细错误信息

3. **模型训练失败**
   - 检查数据量是否足够（建议至少1000个事件）
   - 确认特征处理是否成功
   - 查看日志文件获取详细错误信息

4. **预测不准确**
   - 增加训练数据量
   - 调整模型参数（contamination、threshold等）
   - 重新训练模型

5. **告警不工作**
   - 检查告警配置是否正确
   - 确认告警渠道是否可用
   - 查看告警日志

### 调试模式

设置环境变量启用调试模式：

```bash
# Windows
set DEBUG=1
python start_monitor.py

# Linux/Mac
export DEBUG=1
python start_monitor.py
```

### 重置系统

如果需要重置系统：

1. 停止程序
2. 删除数据目录：`rm -rf data/`
3. 删除模型目录：`rm -rf models/`
4. 删除日志目录：`rm -rf logs/`
5. 重新启动程序

## 最佳实践

### 数据采集

1. **采集时间**: 建议采集10-30分钟的正常行为数据
2. **采集环境**: 在正常的工作环境中采集
3. **数据质量**: 确保采集期间没有异常行为
4. **多次采集**: 可以多次采集不同时间段的数据

### 模型训练

1. **数据量**: 确保有足够的训练数据
2. **数据质量**: 使用高质量的正常行为数据
3. **参数调优**: 根据实际情况调整模型参数
4. **定期重训**: 定期重新训练模型以适应行为变化

### 异常检测

1. **阈值设置**: 根据实际情况调整异常检测阈值
2. **监控频率**: 定期检查异常统计
3. **告警处理**: 及时处理异常告警
4. **模型更新**: 根据检测结果更新模型

### 系统维护

1. **日志清理**: 定期清理日志文件
2. **数据备份**: 定期备份重要数据
3. **性能监控**: 监控系统性能
4. **安全更新**: 及时更新系统和依赖

## 高级功能

### 自定义特征

可以在 `src/core/feature_engineer/` 中添加新的特征提取方法。

### 自定义算法

可以在 `src/core/model_trainer/` 中添加新的机器学习算法。

### 自定义告警

可以在 `src/core/alert/` 中添加新的告警渠道。

### 批量处理

系统支持批量处理多个用户的数据：

```python
# 批量处理示例
for user_id in user_list:
    feature_processor.process_all_user_sessions(user_id)
    model_trainer.train_user_model(user_id)
```

## 性能优化

### 内存优化

1. **数据分块**: 大文件分块处理
2. **及时清理**: 及时清理临时数据
3. **内存监控**: 监控内存使用情况

### 速度优化

1. **并行处理**: 使用多线程处理
2. **缓存机制**: 缓存常用数据
3. **算法优化**: 选择高效的算法

### 存储优化

1. **数据压缩**: 压缩历史数据
2. **定期清理**: 清理过期数据
3. **索引优化**: 优化数据库索引

## 安全考虑

1. **权限控制**: 确保程序有适当的权限
2. **数据保护**: 保护用户隐私数据
3. **日志安全**: 保护日志文件安全
4. **网络安全**: 如果部署到网络环境，注意网络安全

## 扩展开发

### 添加新功能

1. 在相应的模块中添加新功能
2. 更新配置文件
3. 添加相应的快捷键（如需要）
4. 更新文档

### 集成其他系统

1. 实现相应的接口
2. 处理数据格式转换
3. 处理错误和异常
4. 添加日志记录

### 部署到生产环境

1. 配置生产环境
2. 设置监控和告警
3. 配置备份策略
4. 设置安全策略 