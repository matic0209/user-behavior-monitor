# 用户行为异常检测系统 - 产品架构

## 🎯 产品定位

**用户行为异常检测系统** 是一个基于机器学习的智能安全监控产品，通过实时分析用户的鼠标行为模式，检测异常行为并自动采取安全措施。

### 核心价值
- **主动防护**: 在异常行为发生前进行预警
- **智能识别**: 基于机器学习自动识别异常模式
- **自动响应**: 检测到异常时自动锁屏保护
- **隐私保护**: 本地处理，数据不出本地

## 🏗️ 系统架构

### 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    用户行为异常检测系统                      │
├─────────────────────────────────────────────────────────────┤
│  用户界面层 (UI Layer)                                     │
│  ├── 快捷键控制界面                                        │
│  ├── 状态监控界面                                          │
│  └── 告警弹窗界面                                          │
├─────────────────────────────────────────────────────────────┤
│  业务逻辑层 (Business Logic Layer)                         │
│  ├── 用户管理模块                                          │
│  ├── 数据采集模块                                          │
│  ├── 特征工程模块                                          │
│  ├── 模型训练模块                                          │
│  ├── 预测推理模块                                          │
│  └── 告警响应模块                                          │
├─────────────────────────────────────────────────────────────┤
│  数据层 (Data Layer)                                       │
│  ├── SQLite数据库                                          │
│  ├── 模型存储                                              │
│  ├── 日志系统                                              │
│  └── 配置文件                                              │
├─────────────────────────────────────────────────────────────┤
│  系统接口层 (System Interface Layer)                       │
│  ├── Windows API (鼠标事件)                                │
│  ├── 系统锁屏接口                                          │
│  └── GUI接口 (tkinter)                                     │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 核心业务流程

### 1. 系统初始化流程
```
启动系统 → 加载配置 → 初始化模块 → 启动用户管理 → 显示快捷键说明
```

### 2. 数据采集流程
```
用户按 cccc → 开始数据采集 → 监听鼠标事件 → 存储到数据库 → 用户按 ssss → 停止采集
```

### 3. 模型训练流程
```
用户按 ffff → 处理特征 → 提取行为特征 → 用户按 tttt → 训练模型 → 保存模型文件
```

### 4. 异常检测流程
```
用户按 pppp → 开始预测 → 实时采集数据 → 特征提取 → 模型预测 → 异常判断 → 告警响应
```

### 5. 告警响应流程
```
检测到异常 → 显示警告弹窗 → 倒计时10秒 → 强制锁屏 → 记录告警日志
```

## 📊 功能模块详解

### 1. 用户管理模块 (UserManager)
**职责**: 用户身份管理、会话管理、快捷键监听
**核心功能**:
- 自动生成用户ID (Windows用户名_时间戳)
- 管理用户会话和配置
- 监听键盘快捷键
- 提供回调函数机制

**关键特性**:
- 支持连续按键检测 (4次相同按键)
- 自动保存用户配置
- 支持重新训练模式

### 2. 数据采集模块 (DataCollector)
**职责**: 实时采集用户行为数据
**核心功能**:
- 监听鼠标移动、点击、滚动事件
- 记录事件时间戳、坐标、按钮信息
- 数据缓冲和批量存储
- 会话管理和数据组织

**关键特性**:
- 高精度时间戳记录
- 内存缓冲区优化
- 自动会话管理
- 数据完整性验证

### 3. 特征工程模块 (FeatureProcessor)
**职责**: 从原始数据中提取行为特征
**核心功能**:
- 速度特征 (移动速度、加速度)
- 轨迹特征 (路径复杂度、方向变化)
- 时间特征 (点击间隔、持续时间)
- 统计特征 (均值、方差、分布)
- 几何特征 (坐标分布、点击模式)

**关键特性**:
- 滑动窗口处理
- 多维度特征提取
- 特征标准化
- 数据清洗和验证

### 4. 模型训练模块 (ModelTrainer)
**职责**: 训练异常检测模型
**核心功能**:
- 数据预处理和清洗
- 特征选择和工程
- 模型训练和验证
- 模型性能评估
- 模型文件管理

**关键特性**:
- 支持多种算法 (XGBoost, Isolation Forest)
- 自动超参数调优
- 交叉验证
- 模型版本管理

### 5. 预测推理模块 (Predictor)
**职责**: 实时异常检测
**核心功能**:
- 实时数据采集
- 特征提取和预处理
- 模型推理
- 异常分数计算
- 结果缓存和优化

**关键特性**:
- 低延迟推理
- 批量处理优化
- 异常分数阈值管理
- 预测结果缓存

### 6. 告警响应模块 (AlertService)
**职责**: 异常告警和响应
**核心功能**:
- 异常检测触发
- 告警级别管理
- 系统操作执行
- 告警日志记录
- 统计信息管理

**关键特性**:
- 多级别告警 (警告、严重、紧急)
- 强制锁屏功能
- 不可关闭的警告弹窗
- 告警冷却机制
- 跨平台支持

## ⚙️ 配置管理

### 配置文件结构
```yaml
# 系统配置
system:
  platform: "windows"
  debug_mode: true
  max_workers: 4
  memory_limit: "2GB"

# 数据采集配置
data_collection:
  collection_interval: 0.1
  max_buffer_size: 10000
  mouse_events: true
  keyboard_events: false

# 特征工程配置
feature_engineering:
  velocity_features: true
  temporal_features: true
  trajectory_features: true
  statistical_features: true
  geometric_features: true

# 模型配置
model:
  algorithm: "xgboost"
  params:
    max_depth: 6
    learning_rate: 0.1
    n_estimators: 100

# 预测配置
prediction:
  threshold: 0.8
  batch_size: 50
  interval: 5
  anomaly_threshold: 0.7

# 告警配置
alert:
  enable_system_actions: true
  lock_screen_threshold: 0.8
  warning_duration: 10
  alert_cooldown: 60
  show_warning_dialog: true

# 日志配置
logging:
  level: "DEBUG"
  file_rotation: true
  max_file_size: "50MB"
```

## 🔧 技术栈

### 核心技术
- **Python 3.7+**: 主要开发语言
- **SQLite**: 本地数据存储
- **XGBoost**: 机器学习算法
- **pandas/numpy**: 数据处理
- **tkinter**: GUI界面
- **pywin32**: Windows API接口

### 依赖管理
- **requirements.txt**: 依赖包列表
- **自动安装脚本**: 一键安装依赖
- **版本兼容性**: 确保各组件版本兼容

## 📈 性能指标

### 系统性能
- **响应时间**: < 100ms (异常检测)
- **内存使用**: < 500MB
- **CPU使用**: < 10% (正常状态)
- **数据采集**: 1000+ 事件/秒

### 检测性能
- **准确率**: > 90%
- **召回率**: > 85%
- **误报率**: < 5%
- **检测延迟**: < 1秒

## 🛡️ 安全特性

### 数据安全
- **本地存储**: 所有数据本地处理
- **数据加密**: 敏感数据加密存储
- **访问控制**: 用户权限管理
- **数据清理**: 定期清理过期数据

### 系统安全
- **强制锁屏**: 异常时强制锁屏
- **不可关闭弹窗**: 防止用户绕过安全机制
- **告警冷却**: 防止告警风暴
- **日志审计**: 完整的操作日志

## 🚀 部署方案

### 开发环境
```bash
# 1. 克隆项目
git clone <repository>
cd user-behavior-monitor

# 2. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows

# 3. 安装依赖
python install_dependencies.py

# 4. 启动系统
python start_monitor.py
```

### 生产环境
```bash
# 1. 系统要求
- Windows 10/11
- Python 3.7+
- 2GB+ RAM
- 1GB+ 磁盘空间

# 2. 安装步骤
- 下载发布包
- 解压到目标目录
- 运行安装脚本
- 配置系统参数
- 启动服务

# 3. 监控和维护
- 定期检查日志
- 更新模型
- 备份数据
- 性能监控
```

## 📋 使用指南

### 快速开始
1. **启动系统**: `python start_monitor.py`
2. **数据采集**: 按 `cccc` 开始，按 `ssss` 停止
3. **特征处理**: 按 `ffff` 处理特征
4. **模型训练**: 按 `tttt` 训练模型
5. **开始监控**: 按 `pppp` 开始异常检测
6. **查看状态**: 按 `iiii` 查看系统状态

### 快捷键说明
| 快捷键 | 功能 | 说明 |
|--------|------|------|
| `cccc` | 开始数据采集 | 收集鼠标行为数据 |
| `ssss` | 停止数据采集 | 停止数据采集 |
| `ffff` | 处理特征 | 提取行为特征 |
| `tttt` | 训练模型 | 训练异常检测模型 |
| `pppp` | 开始预测 | 开始在线异常检测 |
| `xxxx` | 停止预测 | 停止在线检测 |
| `rrrr` | 重新训练 | 重新训练模型 |
| `iiii` | 显示状态 | 查看系统状态 |
| `qqqq` | 退出系统 | 安全退出系统 |

## 🔄 版本规划

### v1.0 (当前版本)
- ✅ 基础异常检测功能
- ✅ 鼠标行为监控
- ✅ 自动锁屏功能
- ✅ 快捷键控制

### v2.0 (计划中)
- 🔄 键盘行为监控
- 🔄 应用程序监控
- 🔄 网络行为监控
- 🔄 多用户支持

### v3.0 (未来版本)
- 📋 云端模型训练
- 📋 多设备同步
- 📋 高级分析报告
- 📋 企业级部署

## 📞 技术支持

### 常见问题
1. **依赖安装失败**: 使用 `python install_dependencies.py`
2. **快捷键无响应**: 以管理员权限运行
3. **数据采集失败**: 检查鼠标权限设置
4. **模型训练失败**: 确保有足够的数据

### 调试工具
- `test_debug_logging.py`: 调试日志测试
- `test_system_consistency.py`: 系统一致性测试
- `diagnose_data_flow.py`: 数据流诊断
- `test_warning_dialog.py`: 告警功能测试

### 日志文件
- `logs/monitor_*.log`: 主日志
- `logs/error_*.log`: 错误日志
- `logs/debug_*.log`: 调试日志
- `logs/alerts/`: 告警日志

---

*本文档描述了用户行为异常检测系统的完整产品架构，为系统的开发、部署和维护提供指导。* 