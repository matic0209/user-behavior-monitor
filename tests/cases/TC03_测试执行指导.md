# TC03 基于深度学习的用户行为分类功能 - 测试执行指导

## 🎯 测试目标

验证系统具备完整的行为分类功能：
- **分类流程完整性**：系统能正常运行分类预测流程
- **分类结果输出**：能输出正常和异常两种分类结果
- **手动异常触发**：通过aaaa键强制产生可靠的异常分类结果
- **系统响应机制**：异常分类能触发相应的告警和系统响应

## ✅ 为什么这个测试是可靠的

**关键优势**：我们使用**手动触发异常功能(aaaa键)**来保证测试的可靠性
- 🎯 **100%可靠**：手动触发会强制创建异常数据，不依赖模型预测准确性
- 📊 **固定结果**：`anomaly_score=0.95, prediction=0, is_normal=False`
- 🔧 **系统内置**：这是系统自带的测试功能，专门用于验证分类和告警机制

## 📋 测试前准备

### 1. 环境检查
```bash
# 确认可执行文件存在
ls dist/UserBehaviorMonitor.exe

# 确认数据库中有训练数据
sqlite3 data/mouse_data.db "SELECT COUNT(*) FROM features;"
```

### 2. 日志监控准备
```bash
# 打开新终端窗口监控日志
tail -f logs/monitor_*.log
```

## 🔍 详细测试步骤

### 步骤1：启动系统并等待准备完成
**操作**: 运行 `./dist/UserBehaviorMonitor.exe`

**关键日志标识**:
- ✅ `"=== 开始模型训练 ==="`
- ✅ `"模型训练完成"`
- ✅ `"=== 开始在线预测 ==="`
- ✅ `"start_continuous_prediction"`

**验证要点**: 系统能正常启动并完成初始化

---

### 步骤2：本人正常操作测试
**操作**: 
- 正常节奏移动鼠标（每秒2-3次移动）
- 正常点击操作（左键、右键）
- 保持自然的操作习惯

**期望日志**:
```
用户 user_xxx 预测结果: 正常 5, 异常 0
```

**验证要点**: 
- 系统识别为正常行为
- 无异常告警触发
- 异常计数为0

---

### 步骤3：手动触发异常测试（核心步骤）
**操作**: 连续按4次 `a` 键 (aaaa)

**期望日志**:
```
=== 手动触发告警测试开始 ===
[SUCCESS] 手动触发告警，显示安全警告弹窗
✅ 手动告警触发成功
异常分数: 0.950
触发类型: manual_test
=== 手动触发告警测试完成 ===
```

**验证要点**: 
- ✅ **100%可靠**：手动触发不依赖模型准确性
- ✅ **强制异常**：系统会创建固定的异常数据
- ✅ **完整流程**：验证从异常检测到告警响应的完整链路

---

### 步骤4：验证异常告警响应
**当步骤3触发异常时，观察**:

**期望响应**:
```
[系统] 检测到 X 个异常行为
检测到异常行为: 异常分数 0.XXX
```

**可能的系统动作**:
- 弹出告警对话框
- 控制台警告信息
- 如果异常分数>0.8，可能触发锁屏警告

**验证要点**: 系统能正确响应异常行为

---

### 步骤5：手动触发异常测试
**操作**: 连续按4次 `a` 键 (aaaa)

**期望响应**:
```
手动触发异常检测测试
[系统] 手动触发告警测试
```

**验证要点**: 
- 手动触发功能正常
- 能模拟异常行为响应
- 测试系统告警机制

---

### 步骤6：检查数据库记录
**操作**: 
```bash
sqlite3 data/mouse_data.db "
SELECT user_id, prediction, is_normal, anomaly_score, created_at 
FROM predictions 
ORDER BY created_at DESC 
LIMIT 10;
"
```

**期望结果**:
- 正常行为记录: `prediction=1, is_normal=1, anomaly_score<0.5`
- 异常行为记录: `prediction=0, is_normal=0, anomaly_score>0.5`

**验证要点**: 分类结果正确存储

---

### 步骤7：优雅退出
**操作**: 连续按4次 `q` 键 (qqqq)

**期望响应**:
```
收到退出信号，正在关闭系统...
数据采集已停止
预测服务已停止
系统已安全退出
```

**验证要点**: 系统能正常退出，数据保存完整

## 🎯 成功标准

### ✅ 必须满足的条件
1. **分类功能正常**: 能区分正常和异常行为
2. **告警机制有效**: 异常行为能触发相应告警
3. **数据记录完整**: 分类结果正确存储到数据库
4. **系统响应正确**: 不同行为类型有不同的系统响应

### 📊 关键指标验证
- **正常行为识别率**: 正常操作应该被识别为 `is_normal=True`
- **异常行为检测率**: 异常操作应该被识别为 `is_normal=False`
- **告警触发准确性**: 高异常分数应该触发告警
- **数据一致性**: 日志和数据库记录应该一致

## 🚨 常见问题排查

### 问题1：系统无法启动
**检查**:
- Python环境是否正确
- 依赖包是否完整
- 数据库文件是否存在

### 问题2：无法识别异常行为
**可能原因**:
- 训练数据不足
- 模型未正确加载
- 特征提取异常

**排查方法**:
```bash
# 检查模型文件
ls models/user_*_model.pkl

# 检查训练数据
sqlite3 data/mouse_data.db "SELECT COUNT(*) FROM features;"
```

### 问题3：告警不触发
**检查配置**:
```bash
# 查看告警配置
grep -r "lock_screen_threshold" src/utils/config/
```

### 问题4：数据库记录异常
**验证数据**:
```bash
# 检查predictions表结构
sqlite3 data/mouse_data.db ".schema predictions"

# 检查最新记录
sqlite3 data/mouse_data.db "SELECT * FROM predictions ORDER BY created_at DESC LIMIT 5;"
```

## 📝 测试报告模板

```
TC03测试执行结果：

✅/❌ 步骤1：系统启动 - [通过/不通过]
✅/❌ 步骤2：正常行为识别 - [通过/不通过]  
✅/❌ 步骤3：异常行为检测 - [通过/不通过]
✅/❌ 步骤4：告警响应验证 - [通过/不通过]
✅/❌ 步骤5：手动触发测试 - [通过/不通过]
✅/❌ 步骤6：数据库记录验证 - [通过/不通过]
✅/❌ 步骤7：优雅退出 - [通过/不通过]

总体结论：[通过/不通过]
问题描述：[如有问题，详细描述]
建议改进：[如有建议]
```

---

**测试完成后，此测试用例验证了系统满足合同第52条要求：具备基于深度学习的用户行为分类功能，能够区分本人正常行为和非本人潜在异常行为。** ✅
